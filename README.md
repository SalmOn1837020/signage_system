### 文化祭混雑状況管理システム - 技術仕様・引継ぎドキュメント

#### 1. システム概要

本システムは、Djangoフレームワークを用いて開発されたWebアプリケーションです。文化祭の各出し物の混雑状況をリアルタイムで管理・表示し、来場者、出展者、運営者の三者にとって価値のある機能を提供することを目的とします。

*   **来場者**: スマートフォンから混雑状況の確認、出し物の評価、ガチャチケットの獲得ができます。
*   **運営者/出展者**: 管理サイトから出し物情報の管理、各種データの閲覧、QRコードの発行などが行えます。

#### 2. 主要機能一覧

*   **混雑状況管理**: QRコードによる入退室記録で、各出し物の現在人数をリアルタイムに把握・表示。
*   **出し物情報管理**: 管理サイトからの出し物（名称, 団体名, 紹介文, 動画, タグ, 場所等）のCRUD（作成, 読取, 更新, 削除）。
*   **ガチャチケット機能**: 5つの異なる出し物を体験したユーザーにチケットを発行し、職員がQRコードで確認・使用済みにする機能。
*   **評価・ランキング機能**: 来場者による「いいね」評価と、それに基づいたランキングの表示。
*   **多階層なユーザー権限**: 「来場者」「管理者」「ガチャ職員」「出し物職員」「サイネージ」の5つの役割に応じた機能制限。
*   **サイネージ表示**: 大型ディスプレイ向けに最適化された、自動更新の混雑状況表示。
*   **動画配信**: アップロードされた動画をHLS形式に自動変換し、ダウンロードを困難にするストリーミング配信。

#### 3. 技術スタック・開発環境

*   **フレームワーク**: Django
*   **言語**: Python
*   **データベース**: SQLite (開発用・デフォルト)
*   **フロントエンド**: HTML, CSS, JavaScript (外部ライブラリは限定的に使用)
*   **動画処理**: FFmpeg (別途インストールが必要)
*   **Pythonライブラリ**:
    *   `django`: Webフレームワーク本体
    *   `qrcode`, `pillow`: QRコード生成 (現在は外部APIを利用)
    *   `ffmpeg-python`: 動画のHLS変換
    *   (その他、Django関連の標準ライブラリ)

#### 4. プロジェクト構造

```
bunkasai_prj/
├── bunkasai_prj/       # プロジェクト設定ディレクトリ
│   ├── settings.py     # 全体の設定ファイル (DB, ALLOWED_HOSTSなど)
│   └── urls.py         # 全体のURL設定
├── manager/            # メインのアプリケーションディレクトリ
│   ├── admin.py        # 管理サイト(Django Admin)のカスタマイズ
│   ├── forms.py        # ログイン・新規登録フォームの定義
│   ├── models.py       # ★データベースの設計図 (最重要)
│   ├── views.py        # ★アプリケーションの主要ロジック (最重要)
│   ├── urls.py         # managerアプリ内のURL設定
│   └── migrations/     # DB構造の変更履歴
├── media/              # (自動生成) ユーザーがアップロードしたファイル (動画など)
│   └── videos/
├── static/             # (手動作成) CSS, JS, 画像ファイルなど (今回は未使用)
├── templates/          # HTMLテンプレート
│   ├── admin/
│   │   ├── base_site.html  # 管理サイトのヘッダーカスタマイズ
│   │   └── ranking.html    # ランキングページ
│   └── manager/
│       ├── base.html       # 全ページの基礎となるテンプレート
│       ├── attraction_list.html # 混雑状況一覧ページ
│       └── ... (その他各ページのHTML)
├── db.sqlite3          # データベースファイル
└── manage.py           # プロジェクト管理用スクリプト
```

#### 5. データベース設計 (`manager/models.py`)

本システムの中心となるデータ構造です。

*   `Tag`: 出し物を分類するためのタグ (例: 食べ物, 演劇)。
*   `User`: Django標準ユーザーを拡張。役割(`role`)と担当出し物(`managed_attractions`)を持つ。
*   `Attraction`: 出し物の全情報。`Tag`や`User`と関連付けられている。動画ファイルが更新されると、`save()`メソッド内でHLS変換が自動実行される。
*   `Like`: 誰がどの出し物に「いいね」したかの記録。
*   `GachaTicket`: ユーザーに発行されたガチャチケットの情報。
*   `UserActivity`: ユーザーの入退室記録と滞在時間。不正対策の基礎データとなる。
*   `SystemLog`: 全ての重要な操作を記録するログ。

#### 6. 主要ロジック・フロー (`manager/views.py`)

*   **入退室処理 (`process_entry`, `process_exit`)**:
    1.  QRコードのURLから`Attraction`を特定。
    2.  人数を増減させ、混雑状況を更新 (`update_attraction_status`)。
    3.  `UserActivity`に開始時刻または終了時刻を記録。
    4.  退室時に、ガチャチケットの発行条件（5ヶ所訪問）をチェック。
*   **動画処理 (`Attraction`モデルの`save`メソッド)**:
    1.  動画ファイルがアップロード/変更されると`save()`が呼ばれる。
    2.  古いファイルが存在すれば、それをサーバーから物理的に削除。
    3.  `ffmpeg-python`ライブラリを通じて`FFmpeg`コマンドを呼び出し、新しい動画をHLS形式に変換。
    4.  生成された再生リストのパスを`hls_playlist`フィールドに保存。
*   **権限管理**:
    *   各View関数の冒頭で`@login_required`デコレータや`if request.user.role == ...`といった条件分岐を用いて、アクセス制御を行っている。

#### 7. 実行・起動方法

1.  **必要なツール**: Python, FFmpegがインストールされている必要があります。
2.  **ライブラリのインストール**:
    ```bash
    pip install -r requirements.txt 
    ```
    *(注: `requirements.txt`がない場合は `pip freeze > requirements.txt`で作成してください)*
3.  **データベースのセットアップ**:
    ```bash
    python manage.py migrate
    ```
4.  **管理者アカウントの作成**:
    ```bash
    python manage.py createsuperuser
    ```
5.  **開発サーバーの起動**:
    *   **ローカルでのテスト**:
        ```bash
        python manage.py runserver
        ```
        (ブラウザで `http://127.0.0.1:8000/` にアクセス)
    *   **LAN内での公開**:
        ```bash
        python manage.py runserver 0.0.0.0:8000
        ```
        (`settings.py`の`ALLOWED_HOSTS`にPCのIPアドレスを追加する必要があります)

#### 8. 今後の改修・拡張案（TODOリスト）

*   **マップ機能の実装**: 本ドキュメントの前に提示したロードマップに基づき実装。
*   **不正対策機能の実装**: `UserActivity`の滞在時間データを利用し、外れ値を検出してガチャ職員に警告を表示するロジックを`gacha_scan_view`に実装。
*   **演劇の状態自動更新**: 現在は手動または人数で状態が変わるが、`start_time`と`end_time`に基づき、「準備中」「開演間近」「上演中」が自動で切り替わるバックグラウンド処理（CeleryやAPSchedulerなど）を導入。
*   **フィルタ機能の強化**: タグだけでなく、「空いている順」「人気（いいね）順」でのソート機能を追加。
*   **PWAの再挑戦**: 環境起因の問題を解決し、オフライン対応やホーム画面設置機能を実装。
*   **本番環境へのデプロイ**: 開発用サーバーではなく、GunicornやNginxなどを使った、より堅牢な本番環境を構築。
