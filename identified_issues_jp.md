## 今後の改修・拡張案および潜在的な問題点

### README.md より抜粋: 今後の改修・拡張案（TODOリスト）

*   **マップ機能の実装**: 本ドキュメントの前に提示したロードマップに基づき実装。
*   **不正対策機能の実装**: `UserActivity`の滞在時間データを利用し、外れ値を検出してガチャ職員に警告を表示するロジックを`gacha_scan_view`に実装。
*   **演劇の状態自動更新**: 現在は手動または人数で状態が変わるが、`start_time`と`end_time`に基づき、「準備中」「開演間近」「上演中」が自動で切り替わるバックグラウンド処理（CeleryやAPSchedulerなど）を導入。
*   **フィルタ機能の強化**: タグだけでなく、「空いている順」「人気（いいね）順」でのソート機能を追加。
*   **PWAの再挑戦**: 環境起因の問題を解決し、オフライン対応やホーム画面設置機能を実装。
*   **本番環境へのデプロイ**: 開発用サーバーではなく、GunicornやNginxなどを使った、より堅牢な本番環境を構築。

### README.md およびコードレビューから特定されたその他の問題点・改善領域

*   **QRコード生成ライブラリ**:
    *   `README.md`の技術スタックセクションに「`qrcode`, `pillow`: QRコード生成 (現在は外部APIを利用)」との記述があります。自己ホスティング型ライブラリへの完全移行または現状の再確認が必要です。
*   **静的ファイル管理**:
    *   `README.md`のプロジェクト構造に「`static/ ... (今回は未使用)`」との記述があります。静的ファイル（CSS, JavaScript, 画像）の配信設定や利用状況が不完全である可能性が示唆されます。
*   **依存関係リスト**:
    *   `README.md`の実行方法に「`requirements.txt`がない場合は `pip freeze > requirements.txt`で作成してください」との注意書きがあります。プロジェクトの依存関係が `requirements.txt` に適切に記録・管理されているか確認が必要です。
*   **動画処理エラーハンドリング (`manager/models.py`)**:
    *   `Attraction`モデルの`save`メソッド内での`ffmpeg.Error`発生時、エラー内容が`print()`で標準出力/標準エラー出力されています。Djangoのロギング機構 (`logging`) を利用した記録方法への変更が望ましいです。
*   **コード内のコメントマーカー (`manager/views.py`)**:
    *   いくつかのビュー関数内に「★★★ この部分が最も重要です ★★★」や「↓↓↓ この行を追加 ↓↓↓」といった開発者向けのコメントが見られます。これらは最近変更された箇所や特に注意を要する箇所を示している可能性があり、コードレビューやリファクタリングの対象となるかもしれません。
*   **ハードコードされたログメッセージ (`manager/views.py`)**:
    *   `process_entry`ビュー内の異常退室処理に関する`SystemLog`メッセージがハードコードされています。より動的なメッセージ生成や、定義済みメッセージテンプレートの利用を検討できます。
*   **いいね機能の条件 (`manager/views.py`)**:
    *   `attraction_detail`ビューでは、いいねが可能かどうかの判定(`can_like`)に`UserActivity.objects.filter(user=request.user, attraction=attraction, exit_time__isnull=False).exists()` が使用されており、これはユーザーが出し物を体験完了したことを意味します。
    *   しかし、実際のいいね処理を行う `like_attraction` ビューでは、`UserActivity.objects.filter(user=user, attraction=attraction).exists()` という条件でチェックしており、入室記録があれば（退室していなくても）いいねが可能です。これは意図した動作か、あるいは `attraction_detail` のロジックと統一すべきか検討が必要です。
*   **不要なコメントアウトコード (`manager/views.py`)**:
    *   `login_view` および `signup_view` に、古い `AuthenticationForm` に関するコメントアウトされたコード行が残っています。現在は `CustomAuthenticationForm` および `CustomUserCreationForm` を使用しているため、これらの不要なコードは削除するのが望ましいです。
*   **UserActivityの重複登録可能性 (`manager/models.py`, `manager/views.py`)**:
    *   `UserActivity` モデルの `Meta` クラスで `unique_together = ('user', 'attraction')` が設定されています。
    *   `process_exit` ビューでは `UserActivity.objects.get_or_create(user=user, attraction=attraction)` を使用しており、これはユーザーが同じ出し物に再入室した場合に新しい `UserActivity` レコードを作成せず、既存のレコードを取得します。しかし、`entry_time` は `auto_now_add=True` のため、最初の入室時間のみが記録されます。
    *   もしユーザーが同じ出し物に複数回出入りした場合の各滞在時間を記録したいのであれば、`unique_together` の制約を見直すか、別の方法で複数回の訪問を管理する必要があります。現状では、最初の入室と最後の退室（複数回訪問した場合）の間の一つの記録しか残らない可能性があります（ただし `process_entry` での異常退室処理でセッションをクリアしているため、基本的には1アトラクション1アクティビティとなりそうですが、厳密な再入場シナリオの挙動確認は必要です）。特に「不正対策機能の実装」で滞在時間データを利用する際には、この記録の正確性が重要になります。
*   **演劇の状態更新ロジックの現状 (`manager/views.py`)**:
    *   `update_attraction_status` 関数では、「演劇または閉店中の場合は、人数に応じたステータス変更は行わない」とされています。これはTODOリストの「演劇の状態自動更新」と関連し、現状では演劇のステータス（準備中、開演間近、上演中）は人数では変動せず、手動または将来実装される時間ベースの自動更新に依存することを示しています。

これらの点を整理し、今後の開発・改修の優先順位付けに役立てることができます。
